name: Local Flyway Migrations (DBflyway ‚Äì SQL Auth)

on:
  push:
    branches: [ main ]
    paths:
      - "services/**/sql/**"
  workflow_dispatch:

# -------------------------------------------------------------------
# Single environment (local only)
# -------------------------------------------------------------------
env:
  ENVIRONMENT: local

  # SQL Server (SQL Authentication)
  DB_HOST: localhost
  DB_PORT: 1433
  DB_NAME: YourDatabaseName
  DB_USER: YourSqlUsername
  DB_PASSWORD: ${{ secrets.DB_PASSWORD }}   # store securely in GitHub secrets

permissions:
  contents: read

jobs:
  migrate:
    name: Flyway Migrate (Local MSSQL)
    runs-on:
      - self-hosted
      - DBflyway

    steps:
      # ---------------------------------------------------------------
      # Step 1: Checkout repository
      # ---------------------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v3

      # ---------------------------------------------------------------
      # Step 2: Ensure Flyway CLI is available
      # (Skip install if already present on runner)
      # ---------------------------------------------------------------
      - name: Install Flyway CLI (if missing)
        shell: bash
        run: |
          if ! command -v flyway &> /dev/null; then
            echo "Installing Flyway..."
            curl -L https://repo1.maven.org/maven2/org/flywaydb/flyway-commandline/10.13.0/flyway-commandline-10.13.0-linux-x64.tar.gz | tar xz
            sudo ln -sf "$PWD"/flyway-10.13.0/flyway /usr/local/bin/flyway
          else
            echo "Flyway already installed"
          fi
          flyway -v

      # ---------------------------------------------------------------
      # Step 3: Run Flyway migrations
      # ---------------------------------------------------------------
      - name: Run Flyway migrations
        shell: bash
        run: |
          set -e

          echo "Running Flyway using SQL Server Authentication"

          # -----------------------------------------------------------
          # Define services & schemas
          # -----------------------------------------------------------
          SERVICES=("service1" "service2")   # üîÅ change as needed
          SCHEMAS=("dbo")                    # üîÅ change as needed

          for SERVICE in "${SERVICES[@]}"; do
            for SCHEMA in "${SCHEMAS[@]}"; do

              echo "-------------------------------------------------"
              echo "Service: $SERVICE | Schema: $SCHEMA"
              echo "-------------------------------------------------"

              cat <<EOF > flyway.conf
              flyway.url=jdbc:sqlserver://${DB_HOST}:${DB_PORT};databaseName=${DB_NAME};encrypt=false;trustServerCertificate=true;loginTimeout=30
              flyway.user=${DB_USER}
              flyway.password=${DB_PASSWORD}
              flyway.schemas=${SCHEMA}
              flyway.table=flyway_schema_history
              flyway.locations=filesystem:services/${SERVICE}/sql
              flyway.baselineOnMigrate=true
              flyway.validateMigrationNaming=true
              flyway.placeholders.schemaName=${SCHEMA}
              EOF

              flyway -configFiles=flyway.conf info
              flyway -configFiles=flyway.conf migrate

            done
          done